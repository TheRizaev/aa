{% extends 'main/base.html' %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - KRONIK{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <div class="header-content">
            <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞</h1>
            <div class="header-controls">
                <div class="date-range-selector">
                    <select id="dateRange" class="date-range-select">
                        <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                        <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                        <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                        <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
                    </select>
                </div>
                <button class="export-button" id="exportData">
                    <span class="icon">üì•</span>
                    –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="analytics-loading" id="analyticsLoading" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</h3>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞</p>
        </div>
    </div>

    <!-- Error State -->
    <div class="analytics-error" id="analyticsError" style="display: none;">
        <div class="error-content">
            <div class="error-icon">üòû</div>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h3>
            <p id="errorMessage">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>
            <button class="retry-button" onclick="window.location.reload()">
                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>
    </div>

    <!-- Main Analytics Content -->
    <div class="analytics-content" id="analyticsContent">
        
        <!-- Overview Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card views-card">
                <div class="stat-icon">üëÅÔ∏è</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalViews">{{ basic_stats.total_views|default:0 }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                    <div class="stat-change" id="viewsChange">
                        <span class="change-icon">üìà</span>
                        <span class="change-value">+0%</span>
                    </div>
                </div>
            </div>

            <div class="stat-card subscribers-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalSubscribers">{{ basic_stats.subscribers|default:0 }}</div>
                    <div class="stat-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                    <div class="stat-change" id="subscribersChange">
                        <span class="change-icon">üìà</span>
                        <span class="change-value">+0%</span>
                    </div>
                </div>
            </div>

            <div class="stat-card engagement-card">
                <div class="stat-icon">üíù</div>
                <div class="stat-content">
                    <div class="stat-value" id="engagementRate">{{ basic_stats.engagement_rate|default:0 }}%</div>
                    <div class="stat-label">–í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å</div>
                    <div class="stat-change" id="engagementChange">
                        <span class="change-icon">üìà</span>
                        <span class="change-value">+0%</span>
                    </div>
                </div>
            </div>

            <div class="stat-card revenue-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalRevenue">‚ÇΩ0.00</div>
                    <div class="stat-label">–î–æ—Ö–æ–¥</div>
                    <div class="stat-change" id="revenueChange">
                        <span class="change-icon">üìà</span>
                        <span class="change-value">+0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Views Over Time Chart -->
            <div class="chart-container views-chart">
                <div class="chart-header">
                    <h3>üìà –ü—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                    <div class="chart-controls">
                        <button class="chart-control active" data-period="daily">–î–µ–Ω—å</button>
                        <button class="chart-control" data-period="weekly">–ù–µ–¥–µ–ª—è</button>
                        <button class="chart-control" data-period="monthly">–ú–µ—Å—è—Ü</button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="viewsChart"></canvas>
                </div>
            </div>

            <!-- Demographics Chart -->
            <div class="chart-container demographics-chart">
                <div class="chart-header">
                    <h3>üåç –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è –∑—Ä–∏—Ç–µ–ª–µ–π</h3>
                </div>
                <div class="chart-content">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Charts Row -->
        <div class="charts-grid">
            <!-- Engagement Chart -->
            <div class="chart-container engagement-chart">
                <div class="chart-header">
                    <h3>üíù –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å</h3>
                </div>
                <div class="chart-content">
                    <canvas id="engagementChart"></canvas>
                </div>
            </div>

            <!-- Traffic Sources -->
            <div class="chart-container traffic-chart">
                <div class="chart-header">
                    <h3>üöÄ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
                </div>
                <div class="chart-content">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Tables Section -->
        <div class="tables-section">
            
            <!-- Top Videos Table -->
            <div class="table-container top-videos-table">
                <div class="table-header">
                    <h3>üèÜ –¢–æ–ø –≤–∏–¥–µ–æ</h3>
                    <button class="view-all-btn" id="viewAllVideos">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button>
                </div>
                <div class="table-content">
                    <table class="analytics-table" id="topVideosTable">
                        <thead>
                            <tr>
                                <th>–í–∏–¥–µ–æ</th>
                                <th>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                                <th>–õ–∞–π–∫–∏</th>
                                <th>–î–∏–∑–ª–∞–π–∫–∏</th>
                                <th>–í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å</th>
                                <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Engagement Metrics Table -->
            <div class="table-container engagement-metrics-table">
                <div class="table-header">
                    <h3>üìä –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏</h3>
                </div>
                <div class="table-content">
                    <table class="analytics-table" id="engagementMetricsTable">
                        <thead>
                            <tr>
                                <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                                <th>–¢—Ä–µ–Ω–¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="table-container recent-activity-table">
                <div class="table-header">
                    <h3>‚ö° –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                </div>
                <div class="table-content">
                    <table class="analytics-table" id="recentActivityTable">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–°–æ–±—ã—Ç–∏–µ</th>
                                <th>–í–∏–¥–µ–æ</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Revenue Analytics (Premium Feature) -->
        <div class="revenue-section" id="revenueSection">
            <div class="section-header">
                <h2>üí∞ –ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤</h2>
                <div class="premium-badge">
                    <span class="badge-icon">üëë</span>
                    <span class="badge-text">Premium</span>
                </div>
            </div>
            
            <div class="revenue-grid">
                <div class="revenue-card total-revenue">
                    <div class="revenue-icon">üíé</div>
                    <div class="revenue-content">
                        <div class="revenue-amount" id="totalRevenueAmount">‚ÇΩ0.00</div>
                        <div class="revenue-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
                        <div class="revenue-period">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
                    </div>
                </div>

                <div class="revenue-card monthly-revenue">
                    <div class="revenue-icon">üìÖ</div>
                    <div class="revenue-content">
                        <div class="revenue-amount" id="monthlyRevenueAmount">‚ÇΩ0.00</div>
                        <div class="revenue-label">–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</div>
                        <div class="revenue-period">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
                    </div>
                </div>

                <div class="revenue-card estimated-revenue">
                    <div class="revenue-icon">üîÆ</div>
                    <div class="revenue-content">
                        <div class="revenue-amount" id="estimatedRevenueAmount">‚ÇΩ0.00</div>
                        <div class="revenue-label">–ü—Ä–æ–≥–Ω–æ–∑ –¥–æ—Ö–æ–¥–∞</div>
                        <div class="revenue-period">–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü</div>
                    </div>
                </div>

                <div class="revenue-card cpm-rate">
                    <div class="revenue-icon">üìä</div>
                    <div class="revenue-content">
                        <div class="revenue-amount" id="cpmRate">‚ÇΩ0.00</div>
                        <div class="revenue-label">CPM</div>
                        <div class="revenue-period">–ó–∞ 1000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                    </div>
                </div>
            </div>

            <div class="revenue-chart-container">
                <div class="chart-header">
                    <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤</h3>
                </div>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Growth Insights -->
        <div class="insights-section" id="insightsSection">
            <div class="section-header">
                <h2>üöÄ –ò–Ω—Å–∞–π—Ç—ã —Ä–æ—Å—Ç–∞</h2>
            </div>
            
            <div class="insights-grid">
                <div class="insight-card positive-insight">
                    <div class="insight-icon">‚úÖ</div>
                    <div class="insight-content">
                        <h3>–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ</h3>
                        <ul id="positiveInsights">
                            <li>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</li>
                        </ul>
                    </div>
                </div>

                <div class="insight-card improvement-insight">
                    <div class="insight-icon">‚ö†Ô∏è</div>
                    <div class="insight-content">
                        <h3>–û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è</h3>
                        <ul id="improvementInsights">
                            <li>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</li>
                        </ul>
                    </div>
                </div>

                <div class="insight-card recommendation-insight">
                    <div class="insight-icon">üí°</div>
                    <div class="insight-content">
                        <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                        <ul id="recommendationInsights">
                            <li>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Video Modal -->
    <div class="modal" id="videoDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∏–¥–µ–æ</h2>
                <button class="modal-close" id="closeVideoModal">&times;</button>
            </div>
            <div class="modal-body" id="videoDetailsContent">
                <!-- Video details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
                    <div class="format-options">
                        <label class="format-option">
                            <input type="radio" name="exportFormat" value="json" checked>
                            <span class="format-icon">üìÑ</span>
                            <span class="format-name">JSON</span>
                            <span class="format-desc">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
                        </label>
                        <label class="format-option">
                            <input type="radio" name="exportFormat" value="csv">
                            <span class="format-icon">üìä</span>
                            <span class="format-name">CSV</span>
                            <span class="format-desc">–¢–∞–±–ª–∏—Ü–∞ –¥–ª—è Excel</span>
                        </label>
                    </div>
                    
                    <h3>–ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö:</h3>
                    <div class="period-options">
                        <select id="exportPeriod" class="export-select">
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                            <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
                            <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                    </div>
                </div>
                
                <div class="export-actions">
                    <button class="export-cancel-btn" id="cancelExport">–û—Ç–º–µ–Ω–∞</button>
                    <button class="export-confirm-btn" id="confirmExport">
                        <span class="icon">üì•</span>
                        –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast -->
<div class="toast" id="analyticsToast">
    <div class="toast-content">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>
</div>

<style>
.analytics-error {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255, 76, 87, 0.1);
    border-radius: 20px;
    margin: 20px 0;
    border-left: 4px solid #ff4c57;
}

.error-content {
    max-width: 500px;
    margin: 0 auto;
}

.error-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.error-content h3 {
    color: #ff4c57;
    margin-bottom: 15px;
    font-size: 24px;
}

.error-content p {
    color: var(--gray-color);
    margin-bottom: 20px;
    line-height: 1.5;
}

.retry-button {
    padding: 12px 24px;
    background: #ff4c57;
    color: white;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.retry-button:hover {
    background: #e74c3c;
    transform: translateY(-2px);
}
</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="{% static 'js/analytics.js' %}"></script>

<script>
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics dashboard loaded');
    
    // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã
    const analyticsContent = document.getElementById('analyticsContent');
    const analyticsLoading = document.getElementById('analyticsLoading');
    const analyticsError = document.getElementById('analyticsError');
    
    if (analyticsContent) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ä–∞–∑—É —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        analyticsContent.style.display = 'block';
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Django, –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö
        const basicStats = {
            total_views: {{ basic_stats.total_views|default:0 }},
            subscribers: {{ basic_stats.subscribers|default:0 }},
            engagement_rate: {{ basic_stats.engagement_rate|default:0 }},
            total_videos: {{ basic_stats.total_videos|default:0 }}
        };
        
        console.log('Basic stats from Django:', basicStats);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å Chart.js, —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
        if (typeof Chart !== 'undefined') {
            setTimeout(() => {
                createInitialCharts();
            }, 500);
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.addEventListener('error', function(e) {
        console.error('JavaScript error:', e.error);
        if (analyticsLoading && analyticsLoading.style.display !== 'none') {
            showErrorState('–û—à–∏–±–∫–∞ JavaScript: ' + e.message);
        }
    });
});

function createInitialCharts() {
    // –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const viewsCanvas = document.getElementById('viewsChart');
    if (viewsCanvas && typeof Chart !== 'undefined') {
        try {
            const ctx = viewsCanvas.getContext('2d');
            
            // –°–æ–∑–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }));
                data.push(Math.floor(Math.random() * 10)); // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
                        data: data,
                        borderColor: 'rgb(37, 88, 159)',
                        backgroundColor: 'rgba(37, 88, 159, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            console.log('Initial views chart created');
        } catch (error) {
            console.error('Error creating initial chart:', error);
        }
    }
    
    // –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –¥–µ–º–æ–≥—Ä–∞—Ñ–∏–∏
    const demoCanvas = document.getElementById('demographicsChart');
    if (demoCanvas && typeof Chart !== 'undefined') {
        try {
            const ctx = demoCanvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Desktop', 'Mobile', 'Tablet'],
                    datasets: [{
                        data: [45, 35, 20],
                        backgroundColor: [
                            'rgb(52, 152, 219)',
                            'rgb(46, 204, 113)',
                            'rgb(241, 196, 15)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            console.log('Demographics chart created');
        } catch (error) {
            console.error('Error creating demographics chart:', error);
        }
    }
    
    // –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
    const engagementCanvas = document.getElementById('engagementChart');
    if (engagementCanvas && typeof Chart !== 'undefined') {
        try {
            const ctx = engagementCanvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–õ–∞–π–∫–∏', '–î–∏–∑–ª–∞–π–∫–∏', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏', '–ü–æ–¥–ø–∏—Å–∫–∏'],
                    datasets: [{
                        data: [
                            {{ basic_stats.total_likes|default:0 }},
                            {{ basic_stats.total_dislikes|default:0 }},
                            0,
                            {{ basic_stats.subscribers|default:0 }}
                        ],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            console.log('Engagement chart created');
        } catch (error) {
            console.error('Error creating engagement chart:', error);
        }
    }
    
    // –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
    const trafficCanvas = document.getElementById('trafficChart');
    if (trafficCanvas && typeof Chart !== 'undefined') {
        try {
            const ctx = trafficCanvas.getContext('2d');
            
            const totalViews = {{ basic_stats.total_views|default:1 }};
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['KRONIK Homepage', 'Search', 'Subscriptions', 'External', 'Direct'],
                    datasets: [{
                        data: [
                            Math.floor(totalViews * 0.4),
                            Math.floor(totalViews * 0.25),
                            Math.floor(totalViews * 0.20),
                            Math.floor(totalViews * 0.10),
                            Math.floor(totalViews * 0.05)
                        ],
                        backgroundColor: [
                            'rgb(37, 88, 159)',
                            'rgb(52, 152, 219)',
                            'rgb(46, 204, 113)',
                            'rgb(241, 196, 15)',
                            'rgb(155, 89, 182)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            console.log('Traffic chart created');
        } catch (error) {
            console.error('Error creating traffic chart:', error);
        }
    }
}

function showErrorState(message) {
    const analyticsLoading = document.getElementById('analyticsLoading');
    const analyticsError = document.getElementById('analyticsError');
    const analyticsContent = document.getElementById('analyticsContent');
    const errorMessage = document.getElementById('errorMessage');
    
    if (analyticsLoading) analyticsLoading.style.display = 'none';
    if (analyticsContent) analyticsContent.style.display = 'none';
    if (analyticsError) {
        analyticsError.style.display = 'block';
        if (errorMessage) errorMessage.textContent = message;
    }
}
</script>
{% endblock %}
    